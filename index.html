<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <style>
        input[type='search'] {
            -webkit-appearance: searchfield;
        }
            
        *::-webkit-search-cancel-button {
            -webkit-appearance: searchfield-cancel-button;
        }

        input[type="search"]::-webkit-search-cancel-button {

            /* Remove default */
            -webkit-appearance: none;

            /* Now your own custom styles */
            height: 14px;
            width: 14px;
            display: block;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAn0lEQVR42u3UMQrDMBBEUZ9WfQqDmm22EaTyjRMHAlM5K+Y7lb0wnUZPIKHlnutOa+25Z4D++MRBX98MD1V/trSppLKHqj9TTBWKcoUqffbUcbBBEhTjBOV4ja4l4OIAZThEOV6jHO8ARXD+gPPvKMABinGOrnu6gTNUawrcQKNCAQ7QeTxORzle3+sDfjJpPCqhJh7GixZq4rHcc9l5A9qZ+WeBhgEuAAAAAElFTkSuQmCC);
            /* setup all the background tweaks for our custom icon */
            background-repeat: no-repeat;

            /* icon size */
            background-size: 14px;
        }

        .theme-toggle-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            /* padding: 0.5rem 1rem; */
            transition: transform 0.2s;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.2);
        }
    </style>
    <div class="container py-4">
        <div class="row">
            <div class="col pb-4"><input type="search" placeholder="filter" id="filter" autofocus spellcheck="false"></div>
            <div class="ms-auto col-6 pb-4 d-flex">
                <select id="status-filter" class="form-select w-auto ms-auto">
                    <option value="">All Statuses</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Complete">Complete</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Proposed">Proposed</option>
                </select>
                
                <div id="notification-permission-container" class="ms-3">
                    <button id="notification-permission-button" class="btn btn-primary">Enable&nbsp;Notifications</button>
                </div>
                <button id="themeToggleButton" class="theme-toggle-btn ms-3" onclick="toggleTheme()">ðŸŒž</button>
            </div>
            <div>
            </div>
        </div>
        <div id="app" class="row">
        </div>
    </div>


    <script>
        const toggle_api = {
            projects: 'https://api.track.toggl.com/api/v9/me/projects',
            workspaces: 'https://api.track.toggl.com/api/v9/workspaces'
        }
        let project_meta = {};
        let TOGGL_API_KEY = localStorage.getItem('toggl_api_key');
        let TOGGL_WORKSPACE_ID = localStorage.getItem('toggl_workspace_id');

        // Request notification permission on page load
        document.addEventListener('DOMContentLoaded', () => {
            const permissionButton = document.getElementById('notification-permission-button');
            const permissionContainer = document.getElementById('notification-permission-container');

            if (Notification.permission === 'granted') {
                permissionContainer.style.display = 'none'; // Hide the button if permission is already granted
                scheduleNextNotification(); // Start scheduling notifications
            } else {
                permissionButton.addEventListener('click', () => {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            permissionContainer.style.display = 'none'; // Hide the button after permission is granted
                            scheduleNextNotification(); // Start scheduling notifications
                        } else {
                            alert('Notification permission is required to enable reminders.');
                        }
                    });
                });
            }

            if (!TOGGL_API_KEY) {
                // Create modal
                const modalHtml = `
                    <div class="modal fade" id="apiKeyModal" tabindex="-1" aria-labelledby="apiKeyModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="apiKeyModalLabel">Enter Toggl API Key</h5>
                                </div>
                                <div class="modal-body">
                                    <input type="text" id="apiKeyInput" class="form-control" placeholder="API Key">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" id="saveApiKeyBtn" class="btn btn-primary">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const apiKeyModal = new bootstrap.Modal(document.getElementById('apiKeyModal'));
                apiKeyModal.show();

                document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
                    const key = document.getElementById('apiKeyInput').value.trim();
                    if (key) {
                        localStorage.setItem('toggl_api_key', key);
                        TOGGL_API_KEY = key;
                        apiKeyModal.hide();
                        // fetchProjectsMetadata().then(fetchProjects().then(projects => displayProjects(projects)));
                        fetchProjectsMetadata()
                        .then(fetchProjects().then(projects => displayProjects(projects)));
                    }
                });
            } else {
                fetchProjectsMetadata()
                .then(fetchProjects().then(projects => displayProjects(projects)));
            }
        });

        // Function to show a notification
        function showNotification() {
            if (Notification.permission === 'granted') {
                new Notification(`What are you working on?`, {
                    // body: `It's time to log your work!`,
                    // icon: `` // Replace with your own icon URL if needed
                });
            }
        }

        // Function to calculate the time until the next hour or half-hour
        function scheduleNextNotification() {
            const now = new Date();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const milliseconds = now.getMilliseconds();

            // Calculate the time until the next hour or half-hour
            let minutesToNext = 30 - (minutes % 30);
            if (minutesToNext === 30) {
                minutesToNext = 0; // If it's exactly on the hour or half-hour
            }

            let timeToNext = (minutesToNext * 60 * 1000) - (seconds * 1000) - milliseconds;
            if ( timeToNext < 60000 ) {
                timeToNext = 60000; // Minimum 1 minute interval
            }

            // Schedule the notification
            setTimeout(() => {
                showNotification();
                scheduleNextNotification(); // Schedule the next notification
            }, timeToNext);
        }

        async function fetchProjectsMetadata() {
            const response = await fetch( 'projects.json', {
                method: 'GET',
            });
            project_meta = await response.json();
            // projects = projects.filter(project => !project.name.includes('__Inactive'));
            // return projects_meta;
        }
        
        async function fetchProjects() {
            const response = await fetch( toggle_api.projects, {
                method: 'GET',
                headers: {
                    Authorization: 'Basic ' + btoa(localStorage.getItem('toggl_api_key') + ':api_token'),
                }
            });
            let projects = await response.json();
            projects = projects.filter(project => !project.name.includes('__Inactive'));
            const uniqueStatuses = [...new Set(projects.map(project => project.status))];
            return projects;
        }
        
        // this method is not used since we get the workspace from the api and put it on the project time button
        async function fetchWorkspaces() {
            const response = await fetch( toggle_api.workspaces, {
                method: 'GET',
                headers: {
                    Authorization: 'Basic ' + btoa(localStorage.getItem('toggl_api_key') + ':api_token'),
                }
            });
            let workspaces = await response.json();
            // console.log( workspaces );
            localStorage.setItem('toggl_workspace_id', workspaces[0].id);
            //workspaces = workspaces.filter(workspace => !workspace.name.includes('__Inactive'));
            
        }
        
        function displayProjects(projects) {
            
            projects.sort((a, b) => {
                if (a.client_id === b.client_id) {
                    return a.name.localeCompare(b.name);
                }
                return a.client_id - b.client_id;
            });

            console.log( projects );

            const appDiv = document.getElementById('app');
            projects.forEach(project => {
                const elm = document.createElement('div');
                elm.classList.add('card-container','col-lg-3','col-sm-6','mb-3');
                let status = "In Progress";
                if (project_meta[project.name] && project_meta[project.name].status) {
                    status = project_meta[project.name].status;
                }
                elm.setAttribute('data-status', status);
                let content = `
                    <div class="card h-100">
                        <div class="card-header d-flex gap-2">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${project.color}" class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8"/>
                                </svg>
                            </div>
                            <div class="filter-search">
                                ${project.name}<br>
                                <small>${project.client_name != null ? project.client_name : ''}</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="btn-group w-100" role="group" aria-label="Basic example">
                                <button type="button" class="w-33 btn btn-outline-secondary" data-workspace="${project.workspace_id}" data-project="${project.id}" data-time="900">15 min</button>
                                <button type="button" class="w-33 btn btn-outline-secondary" data-workspace="${project.workspace_id}" data-project="${project.id}" data-time="1800">30 min</button>
                                <button type="button" class="w-33 btn btn-outline-secondary" data-workspace="${project.workspace_id}" data-project="${project.id}" data-time="3600">1 hr</button>
                            </div>
                        </div>
                `;
                if ( project_meta[project.name] && project_meta[project.name].url ) {
                    // we want to add some ui for the hours
                    content += `<div class="card-footer">`;
                    content += `<div style="position: absolute; top: 0.5rem; right: 0.5rem;">
                        <a href="${project_meta[project.name].url}" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
                            <svg fill="#000000" viewBox="0 0 24 24" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" d="M5,2 L7,2 C7.55228475,2 8,2.44771525 8,3 C8,3.51283584 7.61395981,3.93550716 7.11662113,3.99327227 L7,4 L5,4 C4.48716416,4 4.06449284,4.38604019 4.00672773,4.88337887 L4,5 L4,19 C4,19.5128358 4.38604019,19.9355072 4.88337887,19.9932723 L5,20 L19,20 C19.5128358,20 19.9355072,19.6139598 19.9932723,19.1166211 L20,19 L20,17 C20,16.4477153 20.4477153,16 21,16 C21.5128358,16 21.9355072,16.3860402 21.9932723,16.8833789 L22,17 L22,19 C22,20.5976809 20.75108,21.9036609 19.1762728,21.9949073 L19,22 L5,22 C3.40231912,22 2.09633912,20.75108 2.00509269,19.1762728 L2,19 L2,5 C2,3.40231912 3.24891996,2.09633912 4.82372721,2.00509269 L5,2 L7,2 L5,2 Z M21,2 L21.081,2.003 L21.2007258,2.02024007 L21.2007258,2.02024007 L21.3121425,2.04973809 L21.3121425,2.04973809 L21.4232215,2.09367336 L21.5207088,2.14599545 L21.5207088,2.14599545 L21.6167501,2.21278596 L21.7071068,2.29289322 L21.7071068,2.29289322 L21.8036654,2.40469339 L21.8036654,2.40469339 L21.8753288,2.5159379 L21.9063462,2.57690085 L21.9063462,2.57690085 L21.9401141,2.65834962 L21.9401141,2.65834962 L21.9641549,2.73400703 L21.9641549,2.73400703 L21.9930928,2.8819045 L21.9930928,2.8819045 L22,3 L22,3 L22,9 C22,9.55228475 21.5522847,10 21,10 C20.4477153,10 20,9.55228475 20,9 L20,5.414 L13.7071068,11.7071068 C13.3466228,12.0675907 12.7793918,12.0953203 12.3871006,11.7902954 L12.2928932,11.7071068 C11.9324093,11.3466228 11.9046797,10.7793918 12.2097046,10.3871006 L12.2928932,10.2928932 L18.584,4 L15,4 C14.4477153,4 14,3.55228475 14,3 C14,2.44771525 14.4477153,2 15,2 L21,2 Z"></path> </g></svg>
                        </a>
                    </div>`;
                    Object.entries(project_meta[project.name].employees).forEach(([name, data]) => {
                        let percentage = 0;
                        let percentage_class = 'success';
                        if ( data.estimate == 0 ) {
                            percentage_class = 'danger progress-bar-striped';
                            percentage = 100;
                        } else if ( data.actual < data.estimate ) {
                            percentage = Math.round((data.actual / data.estimate) * 100);
                            if ( percentage > 70 ) {
                                percentage_class = 'warning';
                            }
                            if ( percentage > 90 ) {
                                percentage_class = 'danger';
                            }
                        } else {
                            percentage = Math.round((data.actual / data.estimate) * 100);
                            percentage_class = 'danger progress-bar-striped';
                        }
                        // content += `<div>${name}: ${data.actual} / ${data.estimate}</div>`;
                        content += `<div>${name}: ${data.actual} / ${data.estimate}`;
                        content += `<div class="progress" role="progressbar" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">`;
                        content += `<div class="progress-bar text-bg-${percentage_class}" style="width: ${percentage}%">${percentage}%</div>`;
                        content += `</div></div>`;
                    });
                    content += `</div>`;
                }


                content += `
                    </div>
                `;
                elm.innerHTML = content;
                appDiv.appendChild(elm);
            });
        }

        // method for listening to click events on buttons
        document.addEventListener('click', async function(event) {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.project) {
                const workspaceId = parseInt(event.target.dataset.workspace);
                const projectId = parseInt(event.target.dataset.project, 10);
                const duration = parseInt(event.target.dataset.time);

                // Create modal HTML if not already present
                if (!document.getElementById('timeEntryModal')) {
                    const modalHtml = `
                        <div class="modal fade" id="timeEntryModal" tabindex="-1" aria-labelledby="timeEntryModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="timeEntryModalLabel">Log Time Entry</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="text" id="timeEntryDescription" class="form-control" placeholder="Description" value="Meetings">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelTimeEntryBtn">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="submitTimeEntryBtn">Submit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                }

                // Show modal
                const timeEntryModal = new bootstrap.Modal(document.getElementById('timeEntryModal'));
                timeEntryModal.show();

                function cleanupModalListeners() {
                    document.getElementById('submitTimeEntryBtn').removeEventListener('click', submitHandler);
                    document.getElementById('cancelTimeEntryBtn').removeEventListener('click', cancelHandler);
                    document.getElementById('timeEntryModal').removeEventListener('keydown', escHandler);
                }

                function submitHandler() {
                    const description = document.getElementById('timeEntryDescription').value.trim() || "Meetings";
                    timeEntryModal.hide();
                    cleanupModalListeners();

                    const currentDateTime = new Date().toISOString();
                    const body = {
                        description: description,
                        pid: projectId,
                        wid: workspaceId,
                        start: currentDateTime,
                        duration: duration,
                        created_with: "API"
                    };

                    fetch('https://api.track.toggl.com/api/v9/workspaces/' + workspaceId + '/time_entries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa(localStorage.getItem('toggl_api_key') + ':api_token')
                        },
                        body: JSON.stringify(body)
                    }).then(response => {
                        if (response.ok) {
                            console.log('Time entry created successfully!');
                        } else {
                            console.warn('Failed to create time entry.');
                            alert('Failed to create time entry.');
                        }
                    });
                }

                function cancelHandler() {
                    timeEntryModal.hide();
                    cleanupModalListeners();
                }

                function escHandler(e) {
                    if (e.key === "Escape") {
                        timeEntryModal.hide();
                        cleanupModalListeners();
                    }
                }

                document.getElementById('submitTimeEntryBtn').addEventListener('click', submitHandler);
                document.getElementById('cancelTimeEntryBtn').addEventListener('click', cancelHandler);
                document.getElementById('timeEntryModal').addEventListener('keydown', escHandler);
                setTimeout(() => document.getElementById('timeEntryDescription').focus(), 300);
            }
        });
    
        document.getElementById('filter').addEventListener('input', function() {
            const filterText = this.value.toLowerCase();
            
            filterByStatus();
            const cards = Array.from(document.querySelectorAll('.filter-search')).filter(card => card.closest('.card-container').style.display !== 'none');
            
            cards.forEach(card => {
                const cardText = card.textContent.toLowerCase();
                const cardElement = card.closest('.card-container');
                if (cardText.includes(filterText)) {
                    cardElement.style.display = '';
                } else {
                    cardElement.style.display = 'none';
                }
            });
            
        });

        function filterByStatus() {
            const selectedStatus = document.getElementById('status-filter').value;
            const cards = document.querySelectorAll('.card-container');

            cards.forEach(card => {
                if (!selectedStatus || card.getAttribute('data-status') === selectedStatus) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        document.getElementById('status-filter').addEventListener('change', function() {
            document.getElementById('filter').value = '';
            filterByStatus();
        });

        function toggleTheme() {
            const body = document.body;
            const button = document.getElementById('themeToggleButton');
            const currentTheme = body.getAttribute('data-bs-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-bs-theme', newTheme);
            button.textContent = newTheme === 'dark' ? 'ðŸŒ™' : 'ðŸŒž';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const button = document.getElementById('themeToggleButton');

            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                body.setAttribute('data-bs-theme', 'dark');
                button.textContent = 'ðŸŒ™';
            } else {
                body.setAttribute('data-bs-theme', 'light');
                button.textContent = 'ðŸŒž';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>